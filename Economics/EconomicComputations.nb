(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     51331,       1319]
NotebookOptionsPosition[     45993,       1190]
NotebookOutlinePosition[     46329,       1205]
CellTagsIndexPosition[     46286,       1202]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Economic computations", "Title",
 CellChangeTimes->{{3.7271066814069443`*^9, 
  3.727106684836173*^9}},ExpressionUUID->"60ba662f-3ee6-4d2d-b353-\
d6d9d0d30be5"],

Cell[CellGroupData[{

Cell["Definitions", "Chapter",
 CellChangeTimes->{{3.727106716412622*^9, 
  3.727106721130731*^9}},ExpressionUUID->"4e7ac71f-4885-442e-a569-\
8caa11781301"],

Cell[CellGroupData[{

Cell["Paquetes", "Subchapter",
 CellChangeTimes->{{3.727108489123604*^9, 
  3.727108490069121*^9}},ExpressionUUID->"4fafaa75-edaf-46cf-8726-\
d41ae796cef7"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetDirectory", "[", 
   RowBox[{"NotebookDirectory", "[", "]"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Needs", "[", "\"\<AdvancedMapping`\>\"", "]"}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"b6e72df1-aa88-4e6f-8365-24b21c96271a"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Data import", "Subchapter",
 CellChangeTimes->{{3.727106853297604*^9, 
  3.727106855064786*^9}},ExpressionUUID->"c2b4d8bf-6f05-43da-af37-\
fc2214af38da"],

Cell["\<\
Data is expected to be in a Yahoo Finance-like format, that is a CSV with \
columns with the following:\
\>", "Text",
 CellChangeTimes->{{3.727111230873975*^9, 
  3.727111288963655*^9}},ExpressionUUID->"50bcadff-3138-4cbb-9b00-\
493242ce20f5"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Keys", "[", 
  RowBox[{"First", "[", "database", "]"}], "]"}]], "Input",
 CellChangeTimes->{{3.7271112910155087`*^9, 
  3.727111297869956*^9}},ExpressionUUID->"e218fe3a-dd97-4657-b96b-\
e7aba050f1a4"],

Cell[BoxData[
 TemplateBox[{TagBox[
    DynamicModuleBox[{
     TypeSystem`NestedGrid`PackagePrivate`$state$$ = 
      Data`UnorderedAssociation[
       "RowCount" -> 7, "Length" -> 7, "InitialType" -> TypeSystem`Vector[
          TypeSystem`Atom[String], 7], "Shape" -> 
        TypeSystem`PackageScope`Limited[
          TypeSystem`PackageScope`ColumnShape[
           TypeSystem`PackageScope`AtomShape[86.4]], 7, {}], "InitialData" -> 
        TypeSystem`PackageScope`CacheHandle[1911606939], "Type" -> 
        TypeSystem`Vector[
          TypeSystem`Atom[String], 7], "HandleQ" -> True, "RowTarget" -> 20, 
        "Data" -> TypeSystem`PackageScope`CacheHandle[1911606939]], 
      TypeSystem`NestedGrid`PackagePrivate`$path$$ = {}, 
      TypeSystem`NestedGrid`PackagePrivate`$pos$$ = 1, 
      TypeSystem`NestedGrid`PackagePrivate`$grid$$ = 
      DynamicModule[{
        TypeSystem`NestedGrid`PackagePrivate`renderedGrid = Deploy[
           Style[
            Grid[{{
               Pane[
                Annotation["Date", 
                 TypeSystem`NestedGrid`PackagePrivate`$SliceMarker[1847497345][
                  GeneralUtilities`Slice[1]], "Mouse"], 
                ImageSize -> {{86.4, Full}, Automatic}, 
                Alignment -> {Left, Baseline}]}, {
               Pane[
                Annotation["Open", 
                 TypeSystem`NestedGrid`PackagePrivate`$SliceMarker[1847497345][
                  GeneralUtilities`Slice[2]], "Mouse"], 
                ImageSize -> {{86.4, Full}, Automatic}, 
                Alignment -> {Left, Baseline}]}, {
               Pane[
                Annotation["High", 
                 TypeSystem`NestedGrid`PackagePrivate`$SliceMarker[1847497345][
                  GeneralUtilities`Slice[3]], "Mouse"], 
                ImageSize -> {{86.4, Full}, Automatic}, 
                Alignment -> {Left, Baseline}]}, {
               Pane[
                Annotation["Low", 
                 TypeSystem`NestedGrid`PackagePrivate`$SliceMarker[1847497345][
                  GeneralUtilities`Slice[4]], "Mouse"], 
                ImageSize -> {{86.4, Full}, Automatic}, 
                Alignment -> {Left, Baseline}]}, {
               Pane[
                Annotation["Close", 
                 TypeSystem`NestedGrid`PackagePrivate`$SliceMarker[1847497345][
                  GeneralUtilities`Slice[5]], "Mouse"], 
                ImageSize -> {{86.4, Full}, Automatic}, 
                Alignment -> {Left, Baseline}]}, {
               Pane[
                Annotation["Adj Close", 
                 TypeSystem`NestedGrid`PackagePrivate`$SliceMarker[1847497345][
                  GeneralUtilities`Slice[6]], "Mouse"], 
                ImageSize -> {{86.4, Full}, Automatic}, 
                Alignment -> {Left, Baseline}]}, {
               Pane[
                Annotation["Volume", 
                 TypeSystem`NestedGrid`PackagePrivate`$SliceMarker[1847497345][
                  GeneralUtilities`Slice[7]], "Mouse"], 
                ImageSize -> {{86.4, Full}, Automatic}, 
                Alignment -> {Left, Baseline}]}}, BaseStyle -> {ContextMenu -> {
                 MenuItem["Copy position to clipboard", 
                  KernelExecute[
                   TypeSystem`NestedGrid`PackagePrivate`toCurrentPosition[
                   TypeSystem`NestedGrid`PackagePrivate`copyClip]], 
                  MenuEvaluator -> Automatic], 
                 MenuItem["Copy data to clipboard", 
                  KernelExecute[
                   TypeSystem`NestedGrid`PackagePrivate`toCurrentData[
                   TypeSystem`NestedGrid`PackagePrivate`$state$$, 
                    TypeSystem`NestedGrid`PackagePrivate`copyClip]], 
                  MenuEvaluator -> Automatic], Delimiter, 
                 MenuItem["Paste position in new cell", 
                  KernelExecute[
                   TypeSystem`NestedGrid`PackagePrivate`toCurrentPosition[
                   TypeSystem`NestedGrid`PackagePrivate`cellPaste]], 
                  MenuEvaluator -> Automatic], 
                 MenuItem["Paste data in new cell", 
                  KernelExecute[
                   TypeSystem`NestedGrid`PackagePrivate`toCurrentData[
                   TypeSystem`NestedGrid`PackagePrivate`$state$$, 
                    TypeSystem`NestedGrid`PackagePrivate`cellPaste]], 
                  MenuEvaluator -> Automatic]}, FontFamily -> "Verdana", 
               FontSize -> 12}, Alignment -> Left, RowMinHeight -> 1.5, 
             Dividers -> All, FrameStyle -> GrayLevel[0.85], 
             BaseStyle -> {FontFamily -> "Verdana", FontSize -> 12}], 
            LineBreakWithin -> False, ContextMenu -> {}, NumberMarks -> False,
             ShowAutoStyles -> False]], 
         TypeSystem`NestedGrid`PackagePrivate`initialQ = True, 
         TypeSystem`NestedGrid`PackagePrivate`self = $Failed}, 
        Dynamic[
         TypeSystem`NestedGrid`PackagePrivate`setupViewPath[
         TypeSystem`NestedGrid`PackagePrivate`$path$$, If[
            Not[TypeSystem`NestedGrid`PackagePrivate`initialQ], 
            
            Module[{TypeSystem`NestedGrid`PackagePrivate`tmpGrid$ = $Failed, 
              TypeSystem`NestedGrid`PackagePrivate`tmpData$ = 
              TypeSystem`NestedGrid`PackagePrivate`LookupCacheValue[
                TypeSystem`NestedGrid`PackagePrivate`$state$$["Data"]]}, 
             TypeSystem`NestedGrid`PackagePrivate`tmpGrid$ = 
              If[TypeSystem`NestedGrid`PackagePrivate`tmpData$ === 
                TypeSystem`NestedGrid`PackagePrivate`$NotCached, 
                TypeSystem`NestedGrid`PackagePrivate`renderedGrid, 
                TypeSystem`NestedGrid`PackagePrivate`renderGrid[
                TypeSystem`NestedGrid`PackagePrivate`$state$$, 
                 TypeSystem`NestedGrid`PackagePrivate`$path$$, 
                 TypeSystem`NestedGrid`PackagePrivate`$pos$$, 
                 TypeSystem`NestedGrid`PackagePrivate`$grid$$, 1847497345][
                TypeSystem`NestedGrid`PackagePrivate`tmpData$]]; If[
               Not[
                FailureQ[TypeSystem`NestedGrid`PackagePrivate`tmpGrid$]], 
               TypeSystem`NestedGrid`PackagePrivate`renderedGrid = 
               TypeSystem`NestedGrid`PackagePrivate`tmpGrid$]; Null]]; 
          TypeSystem`NestedGrid`PackagePrivate`initialQ = False; 
          TypeSystem`NestedGrid`PackagePrivate`$pos$$; If[
            FailureQ[TypeSystem`NestedGrid`PackagePrivate`renderedGrid], 
            TypeSystem`SparseGrid[
             TypeSystem`H["(data no longer present)"]], 
            If[GeneralUtilities`$DebugMode, 
             Row[{TypeSystem`NestedGrid`PackagePrivate`renderedGrid, "  ", 
               TypeSystem`NestedGrid`PackagePrivate`formatState[
               TypeSystem`NestedGrid`PackagePrivate`$state$$, 
                TypeSystem`NestedGrid`PackagePrivate`$path$$, 
                TypeSystem`NestedGrid`PackagePrivate`$pos$$]}], 
             TypeSystem`NestedGrid`PackagePrivate`renderedGrid]]], 
         TrackedSymbols :> {TypeSystem`NestedGrid`PackagePrivate`$pos$$}], 
        DynamicModuleValues :> {}], 
      TypeSystem`NestedGrid`PackagePrivate`$posCell$$, 
      TypeSystem`NestedGrid`PackagePrivate`$topBar$$ = Dynamic[
        TypeSystem`NestedGrid`PackagePrivate`alignBar[
        TypeSystem`NestedGrid`PackagePrivate`$state$$][
         TypeSystem`NestedGrid`PackagePrivate`makeFramedBar[
          TypeSystem`PackageScope`Pathbar[
          TypeSystem`NestedGrid`PackagePrivate`$path$$, 
           TypeSystem`NestedGrid`PackagePrivate`updateState[
           TypeSystem`NestedGrid`PackagePrivate`$state$$, 
            TypeSystem`NestedGrid`PackagePrivate`$path$$, 
            TypeSystem`NestedGrid`PackagePrivate`$pos$$, 
            TypeSystem`NestedGrid`PackagePrivate`$grid$$, 1847497345]]]], 
        TrackedSymbols :> {TypeSystem`NestedGrid`PackagePrivate`$path$$}], 
      TypeSystem`NestedGrid`PackagePrivate`$bottomBar$$ = Framed[
        Dynamic[
         Replace[
          MouseAnnotation[Null], {
          TypeSystem`NestedGrid`PackagePrivate`$SliceMarker[1847497345][Null] -> 
           "", TypeSystem`NestedGrid`PackagePrivate`$SliceMarker[1847497345][
             Pattern[TypeSystem`NestedGrid`PackagePrivate`path, 
              Blank[]]] :> (
            TypeSystem`NestedGrid`PackagePrivate`$lastPath = 
             TypeSystem`NestedGrid`PackagePrivate`path; 
            TypeSystem`NestedGrid`PackagePrivate`makePathTrail[
             TypeSystem`NestedGrid`PackagePrivate`path, 
              TypeSystem`NestedGrid`PackagePrivate`makePathElements]), Null :> 
           Spacer[10], Blank[] :> Spacer[10]}], TrackedSymbols :> {}], 
        FrameStyle -> None, ImageMargins -> 0, FrameMargins -> 0, Alignment -> 
        Top, ImageSize -> {Automatic, 14}]}, 
     DynamicBox[
      ToBoxes[
       Column[
        If[TypeSystem`NestedGrid`PackagePrivate`$path$$ == {}, {
          TypeSystem`NestedGrid`PackagePrivate`displayScrollBar[
          TypeSystem`NestedGrid`PackagePrivate`$grid$$, 
           TypeSystem`NestedGrid`PackagePrivate`$state$$, 
           TypeSystem`NestedGrid`PackagePrivate`$pos$$], 
          TypeSystem`NestedGrid`PackagePrivate`onDesktopShow[
           TypeSystem`NestedGrid`PackagePrivate`alignBar[
           TypeSystem`NestedGrid`PackagePrivate`$state$$][
           TypeSystem`NestedGrid`PackagePrivate`$bottomBar$$]]}, {
         TypeSystem`NestedGrid`PackagePrivate`$topBar$$, 
          TypeSystem`NestedGrid`PackagePrivate`displayScrollBar[
          TypeSystem`NestedGrid`PackagePrivate`$grid$$, 
           TypeSystem`NestedGrid`PackagePrivate`$state$$, 
           TypeSystem`NestedGrid`PackagePrivate`$pos$$], 
          TypeSystem`NestedGrid`PackagePrivate`onDesktopShow[
           TypeSystem`NestedGrid`PackagePrivate`alignBar[
           TypeSystem`NestedGrid`PackagePrivate`$state$$][
           TypeSystem`NestedGrid`PackagePrivate`$bottomBar$$]]}], Spacings -> 
        If[TypeSystem`NestedGrid`PackagePrivate`$path$$ == {}, 
          0, {{}, {0, 0.05, 0}}]], StandardForm], 
      ImageSizeCache -> {98., {96., 101.}}, 
      TrackedSymbols :> {
       TypeSystem`NestedGrid`PackagePrivate`$state$$, 
        TypeSystem`NestedGrid`PackagePrivate`$grid$$}], 
     BaseStyle -> {LineBreakWithin -> False}, Deinitialization :> 
     TypeSystem`NestedGrid`PackagePrivate`deleteState[
      TypeSystem`NestedGrid`PackagePrivate`$state$$], 
     DynamicModuleValues :> {}, Initialization :> 
     Block[{$ContextPath = $ContextPath}, 
       Needs["TypeSystem`"]]], Deploy, DefaultBaseStyle -> "Deploy"]},
  "CopyTag",
  DisplayFunction->(#& ),
  InterpretationFunction->("Dataset[<>]"& )]], "Output",
 CellChangeTimes->{
  3.7271921442883587`*^9},ExpressionUUID->"2e948862-d584-4fdc-949b-\
2398557aed8e"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"database", " ", "=", " ", 
   RowBox[{"SemanticImport", "[", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"NotebookDirectory", "[", "]"}], ",", "\"\<^DJI.csv\>\""}], 
      "}"}], "]"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.7271068713698483`*^9, 
  3.727106893328315*^9}},ExpressionUUID->"9d130389-0fcd-42bc-85f2-\
8231008c3059"],

Cell[BoxData[
 RowBox[{"Take", "[", 
  RowBox[{"database", ",", "10"}], "]"}]], "Input",
 CellChangeTimes->{{3.727107199239634*^9, 
  3.7271072038751163`*^9}},ExpressionUUID->"439ed81d-63b6-45fa-b01d-\
113f3eaab47e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Returns", "Subchapter",
 CellChangeTimes->{{3.7271067225213346`*^9, 
  3.7271067257125463`*^9}},ExpressionUUID->"1239b071-363f-41cf-b36c-\
d300db9927bc"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Returns1Day", "[", "prices_", "]"}], ":=", " ", 
   RowBox[{
    RowBox[{"Drop", "[", 
     RowBox[{"prices", ",", "1"}], "]"}], "-", 
    RowBox[{"Drop", "[", 
     RowBox[{"prices", ",", 
      RowBox[{"-", "1"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LogReturns", "[", 
    RowBox[{"prices_", ",", "lag_"}], "]"}], ":=", " ", 
   RowBox[{
    RowBox[{"Log", "[", 
     RowBox[{"Drop", "[", 
      RowBox[{"prices", ",", "lag"}], "]"}], "]"}], "-", 
    RowBox[{"Log", "[", 
     RowBox[{"Drop", "[", 
      RowBox[{"prices", ",", 
       RowBox[{"-", "lag"}]}], "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LogReturns", "[", 
     RowBox[{"dates_", ",", "prices_", ",", "lag_"}], "]"}], ":=", " ", 
    RowBox[{"Transpose", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Drop", "[", 
        RowBox[{"dates", ",", 
         RowBox[{"-", "1"}]}], "]"}], ",", 
       RowBox[{
        RowBox[{"Log", "[", 
         RowBox[{"Drop", "[", 
          RowBox[{"prices", ",", "lag"}], "]"}], "]"}], "-", 
        RowBox[{"Log", "[", 
         RowBox[{"Drop", "[", 
          RowBox[{"prices", ",", 
           RowBox[{"-", "lag"}]}], "]"}], "]"}]}]}], "}"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TrendDuration", "[", "prices_", "]"}], " ", ":=", " ", 
    RowBox[{"Map", "[", 
     RowBox[{"Length", ",", 
      RowBox[{"Split", "[", 
       RowBox[{"Sign", "[", 
        RowBox[{"Returns1Day", "[", "prices", "]"}], "]"}], "]"}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"$VersionNumber", "<", "11.2"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"TakeList", "[", 
       RowBox[{"list_", ",", "seqs_"}], "]"}], ":=", 
      RowBox[{"FoldPairList", "[", 
       RowBox[{"TakeDrop", ",", "list", ",", "seqs"}], "]"}]}], ";"}]}], 
   "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TrendReturns", "[", "prices_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "endpoints", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"endpoints", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"First", ",", 
         RowBox[{"TakeList", "[", 
          RowBox[{"prices", ",", 
           RowBox[{"Append", "[", 
            RowBox[{
             RowBox[{"TrendDuration", "[", "prices", "]"}], ",", "All"}], 
            "]"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"LogReturns", "[", "endpoints", "]"}], "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TrendReturns", "[", 
    RowBox[{"dates_", ",", "prices_"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "endpoints", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"endpoints", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"First", ",", 
         RowBox[{"TakeList", "[", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"{", 
             RowBox[{"dates", ",", "prices"}], "}"}], "]"}], ",", 
           RowBox[{"Append", "[", 
            RowBox[{
             RowBox[{"TrendDuration", "[", "prices", "]"}], ",", "All"}], 
            "]"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"Transpose", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Drop", "[", 
           RowBox[{
            RowBox[{"endpoints", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
            RowBox[{"-", "1"}]}], "]"}], ",", 
          RowBox[{"LogReturns", "[", 
           RowBox[{"endpoints", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "}"}], "]"}], 
       "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.727106731508418*^9, 3.727106731830819*^9}, {
  3.7271073948227797`*^9, 3.727107395062768*^9}, {3.727107524516037*^9, 
  3.72710752990876*^9}, {3.7271100223672953`*^9, 3.727110088754212*^9}, {
  3.727110314003048*^9, 
  3.7271103165843763`*^9}},ExpressionUUID->"00eddca0-14bc-40cb-9e74-\
fc195473e6d4"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Extreme events", "Chapter",
 CellChangeTimes->{{3.727107342517844*^9, 
  3.727107345217608*^9}},ExpressionUUID->"4bcb001a-247f-4b0c-adb2-\
d31dd5d10f88"],

Cell[CellGroupData[{

Cell["Anderson-Darling test", "Subchapter",
 CellChangeTimes->{{3.727107328104505*^9, 
  3.727107332788616*^9}},ExpressionUUID->"02bac1df-e151-4925-a44a-\
99eda3c560cb"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AndersonDarling", "[", 
     RowBox[{"data_", ",", "\[Gamma]_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "s", ",", " ", "n", ",", "\[Alpha]", ",", "z", ",", "A2", ",", "i"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"s", " ", "=", " ", 
        RowBox[{"Sort", "[", "data", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"Count", "[", 
         RowBox[{"s", ",", 
          RowBox[{"x_", "/;", 
           RowBox[{"x", "\[GreaterEqual]", "\[Gamma]"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"n", ">", "1"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"s", " ", "=", " ", 
           RowBox[{"Take", "[", 
            RowBox[{"s", ",", 
             RowBox[{"-", "n"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"\[Alpha]", " ", "=", " ", 
           SuperscriptBox[
            RowBox[{"(", 
             RowBox[{
              FractionBox["1", "n"], " ", 
              RowBox[{"Sum", "[", 
               RowBox[{
                RowBox[{"Log", "[", 
                 FractionBox[
                  RowBox[{"s", "[", 
                   RowBox[{"[", "i", "]"}], "]"}], "\[Gamma]"], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"i", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ")"}], 
            RowBox[{"-", "1"}]]}], ";", "\[IndentingNewLine]", 
          RowBox[{"z", " ", "=", " ", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"1", "-", 
              SuperscriptBox[
               RowBox[{"(", 
                FractionBox["\[Gamma]", 
                 RowBox[{"s", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]], ")"}], "\[Alpha]"]}], ",", 
             
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"A2", " ", "=", " ", 
           RowBox[{
            RowBox[{"-", "n"}], "-", 
            RowBox[{
             FractionBox["1", "n"], 
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"2", "i"}], "-", "1"}], ")"}], 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Log", "[", 
                   RowBox[{"z", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "]"}], "+", 
                  RowBox[{"Log", "[", 
                   RowBox[{"1", "-", 
                    RowBox[{"z", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", "-", "i", "+", "1"}], "]"}], "]"}]}], 
                   "]"}]}], ")"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"i", ",", "1", ",", "n"}], "}"}]}], "]"}]}]}]}], ";", 
          " ", "\[IndentingNewLine]", 
          RowBox[{"Return", "[", "A2", "]"}], ";"}], "\[IndentingNewLine]", 
         ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Return", "[", "\[Infinity]", "]"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LeftCutoff", "[", 
     RowBox[{
     "data_", ",", "\[Gamma]min_", ",", "\[Gamma]max_", ",", "d\[Gamma]_"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"tbl", ",", "minPos", ",", "\[Gamma]"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"tbl", " ", "=", " ", 
        RowBox[{"ProgressTable", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\[Gamma]", ",", 
            RowBox[{"AndersonDarling", "[", 
             RowBox[{"data", ",", "\[Gamma]"}], "]"}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
           "\[Gamma]", ",", "\[Gamma]min", ",", "\[Gamma]max", ",", 
            "d\[Gamma]"}], "}"}], ",", 
          RowBox[{"\"\<ShowInfo\>\"", "\[Rule]", "True"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"tbl", " ", "=", " ", 
        RowBox[{"DeleteCases", "[", 
         RowBox[{"tbl", ",", 
          RowBox[{"{", 
           RowBox[{"_", ",", "\[Infinity]"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"MinimalBy", "[", 
         RowBox[{"tbl", ",", "Last"}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RightCutoff", "[", 
    RowBox[{
    "data_", ",", "\[Gamma]left_", ",", "\[Gamma]max_", ",", "d\[Gamma]_"}], 
    "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"tbl", ",", "maxPos", ",", "\[Gamma]"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"tbl", " ", "=", " ", 
       RowBox[{"ProgressTable", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\[Gamma]", ",", 
           RowBox[{"AndersonDarling", "[", 
            RowBox[{"data", ",", "\[Gamma]"}], "]"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Gamma]", ",", "\[Gamma]max", ",", "\[Gamma]left", ",", 
           RowBox[{"-", "d\[Gamma]"}]}], "}"}], ",", 
         RowBox[{"\"\<ShowInfo\>\"", "\[Rule]", "True"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"tbl", " ", "=", " ", 
       RowBox[{"DeleteCases", "[", 
        RowBox[{"tbl", ",", 
         RowBox[{"{", 
          RowBox[{"_", ",", "\[Infinity]"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"MaximalBy", "[", 
        RowBox[{"tbl", ",", "Last"}], "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.727107487173411*^9, 3.7271075004325867`*^9}, {
  3.727108000287654*^9, 3.727108000574614*^9}, {3.727108031860821*^9, 
  3.727108032324222*^9}, {3.727108122777183*^9, 3.727108185027569*^9}, {
  3.727108351806786*^9, 3.727108368729548*^9}, {3.727108505928026*^9, 
  3.727108525888134*^9}, {3.7271085703213577`*^9, 3.727108570975466*^9}, {
  3.727191255538129*^9, 3.727191269400065*^9}, {3.7271913099716988`*^9, 
  3.727191314339118*^9}},ExpressionUUID->"60e5dcff-79ac-4220-ad81-\
9c903d59974a"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Positive extreme events", "Subchapter",
 CellChangeTimes->{{3.727110424056343*^9, 
  3.7271104282521048`*^9}},ExpressionUUID->"769c1546-351b-48b0-862b-\
75f5a739bcb9"],

Cell["Calculation of the returns", "Text",
 CellChangeTimes->{{3.727109977053843*^9, 
  3.727109983725967*^9}},ExpressionUUID->"d2093ab8-c4bf-4304-b95e-\
96704c1f3f9e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"returns", " ", "=", " ", 
   RowBox[{"LogReturns", "[", 
    RowBox[{
     RowBox[{"Normal", "[", 
      RowBox[{"database", "[", 
       RowBox[{"All", ",", "\"\<Close\>\""}], "]"}], "]"}], ",", "1"}], 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"datedReturns", " ", "=", " ", 
   RowBox[{"LogReturns", "[", 
    RowBox[{
     RowBox[{"Normal", "[", 
      RowBox[{"database", "[", 
       RowBox[{"All", ",", "\"\<Date\>\""}], "]"}], "]"}], ",", 
     RowBox[{"Normal", "[", 
      RowBox[{"database", "[", 
       RowBox[{"All", ",", "\"\<Close\>\""}], "]"}], "]"}], ",", "1"}], 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", " ", "=", " ", 
   RowBox[{"Select", "[", 
    RowBox[{"returns", ",", "Positive"}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.7271083061184387`*^9, 3.72710843851832*^9}, {
  3.727109495336327*^9, 3.727109496838745*^9}, {3.727109670593175*^9, 
  3.7271096748467607`*^9}, {3.727109727743472*^9, 3.727109734025447*^9}, {
  3.727109824331897*^9, 3.72710985014286*^9}, {3.7271101279389467`*^9, 
  3.727110143416807*^9}, {3.727110345153583*^9, 
  3.727110348138723*^9}},ExpressionUUID->"4735b203-3d52-4f8d-9a06-\
9a0867ed6871"],

Cell["Start of power law decay", "Text",
 CellChangeTimes->{{3.727110754730159*^9, 
  3.72711076274268*^9}},ExpressionUUID->"3d83a1ed-9d30-4839-9e93-\
059ecfcf8f0c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"\[Gamma]left", " ", "=", " ", 
   RowBox[{"LeftCutoff", "[", 
    RowBox[{"pos", ",", "0.02", ",", 
     RowBox[{"Max", "[", "pos", "]"}], ",", "0.00001"}], "]"}]}], 
  ";"}]], "Input",ExpressionUUID->"ccfb85eb-7e44-4e81-a54f-338029646bd4"],

Cell["End of power law decay. Extreme events.", "Text",
 CellChangeTimes->{{3.727110765454918*^9, 
  3.7271107769037457`*^9}},ExpressionUUID->"90bf278f-d425-4c4d-957a-\
a749c038d5a0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"\[Gamma]right", "=", " ", 
   RowBox[{"RightCutoff", "[", 
    RowBox[{"pos", ",", "\[Gamma]left", ",", 
     RowBox[{"Max", "[", "pos", "]"}], ",", "0.00001"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.727108555620912*^9, 
  3.727108596121278*^9}},ExpressionUUID->"1a9b39de-9a95-41a7-853b-\
92736e357d8a"],

Cell["\<\
Plot of the distribution. Vertical line is the start of extreme events.\
\>", "Text",
 CellChangeTimes->{{3.727110792031796*^9, 
  3.727110808056546*^9}},ExpressionUUID->"0406e118-3085-441e-a1aa-\
3ac4673a0a83"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"histogramPoints", " ", "=", " ", 
   RowBox[{"Transpose", "[", 
    RowBox[{"MapAt", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Drop", "[", 
        RowBox[{"#", ",", "1"}], "]"}], "&"}], ",", 
      RowBox[{"HistogramList", "[", 
       RowBox[{"pos", ",", "60", ",", "\"\<Probability\>\""}], "]"}], ",", 
      "1"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"ListLogLogPlot", "[", "\[IndentingNewLine]", 
  RowBox[{"histogramPoints", ",", "\[IndentingNewLine]", 
   RowBox[{"GridLines", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", "\[Gamma]right", "}"}], ",", "None"}], "}"}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"PlotRange", "\[Rule]", "Full"}], ",", "\[IndentingNewLine]", 
   RowBox[{"PlotTheme", "\[Rule]", "\"\<Monochrome\>\""}], ",", " ", 
   "\[IndentingNewLine]", 
   RowBox[{"FrameLabel", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Style", "[", 
       RowBox[{"\"\<Returns\>\"", ",", "15"}], "]"}], ",", " ", 
      RowBox[{"Style", "[", 
       RowBox[{"\"\<Probability\>\"", ",", "15"}], "]"}]}], "}"}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"BaseStyle", "\[Rule]", 
    RowBox[{"FontSize", "\[Rule]", "13"}]}], ",", "\[IndentingNewLine]", 
   RowBox[{"ImageSize", "\[Rule]", "500"}], ",", "\[IndentingNewLine]", 
   RowBox[{"PlotMarkers", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
   RowBox[{"GridLines", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "1", "}"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
   RowBox[{"Frame", "\[Rule]", "True"}]}], "\[IndentingNewLine]", 
  "]"}]}], "Input",
 CellChangeTimes->{{3.7271092153048353`*^9, 3.727109254388513*^9}, {
  3.727109501055138*^9, 3.7271095018441267`*^9}, {3.7271107822856417`*^9, 
  3.727110782531336*^9}},ExpressionUUID->"428415c1-8e82-4cce-a30c-\
1a3ccfd1aa91"],

Cell["Dates of extreme event.", "Text",
 CellChangeTimes->{{3.727110811481201*^9, 
  3.7271108167230043`*^9}},ExpressionUUID->"b67cb207-9f3b-4d57-8408-\
17d0be2d58f2"],

Cell[BoxData[
 RowBox[{"Grid", "[", 
  RowBox[{
   RowBox[{"Join", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<Date\>\"", ",", "\"\<Return\>\""}], "}"}], "}"}], ",", 
     RowBox[{"Select", "[", 
      RowBox[{"datedReturns", ",", 
       RowBox[{
        RowBox[{
         RowBox[{"Last", "[", "#", "]"}], ">", "\[Gamma]right"}], "&"}]}], 
      "]"}]}], "]"}], ",", 
   RowBox[{"Frame", "\[Rule]", "All"}], ",", 
   RowBox[{"Background", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "Gray", "}"}]}], "}"}]}]}], "]"}]], "Input",
 CellChangeTimes->{
  3.72711015620656*^9, {3.727110442780514*^9, 
   3.7271104947699347`*^9}},ExpressionUUID->"fdf61b0b-0f5a-4f9c-946f-\
0d59db91fdb6"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Negative extreme events", "Subchapter",
 CellChangeTimes->{{3.72711051110168*^9, 
  3.727110518937776*^9}},ExpressionUUID->"a9c6d213-0b6d-49ab-afa4-\
0a37b1692314"],

Cell["Plot of extreme events.", "Text",
 CellChangeTimes->{{3.7271108333814993`*^9, 
  3.727110836686514*^9}},ExpressionUUID->"1da03ce1-edee-4063-a0e4-\
1f556f090c08"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"neg", " ", "=", " ", 
   RowBox[{"-", 
    RowBox[{"Select", "[", 
     RowBox[{"returns", ",", "Negative"}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Gamma]left", " ", "=", " ", 
   RowBox[{"LeftCutoff", "[", 
    RowBox[{"neg", ",", "0.02", ",", 
     RowBox[{"Max", "[", "neg", "]"}], ",", "0.00001"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Gamma]right", "=", " ", 
   RowBox[{"RightCutoff", "[", 
    RowBox[{"neg", ",", "\[Gamma]left", ",", 
     RowBox[{"Max", "[", "neg", "]"}], ",", "0.00001"}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.7271105249298077`*^9, 
  3.727110555979969*^9}},ExpressionUUID->"e2a04dbf-c369-434e-a3eb-\
7cedd5bea1fa"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"histogramPoints", " ", "=", " ", 
   RowBox[{"Transpose", "[", 
    RowBox[{"MapAt", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Drop", "[", 
        RowBox[{"#", ",", "1"}], "]"}], "&"}], ",", 
      RowBox[{"HistogramList", "[", 
       RowBox[{"neg", ",", "60", ",", "\"\<Probability\>\""}], "]"}], ",", 
      "1"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"ListLogLogPlot", "[", "\[IndentingNewLine]", 
  RowBox[{"histogramPoints", ",", "\[IndentingNewLine]", 
   RowBox[{"GridLines", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", "\[Gamma]right", "}"}], ",", "None"}], "}"}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"PlotRange", "\[Rule]", "Full"}], ",", "\[IndentingNewLine]", 
   RowBox[{"PlotTheme", "\[Rule]", "\"\<Monochrome\>\""}], ",", " ", 
   "\[IndentingNewLine]", 
   RowBox[{"FrameLabel", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Style", "[", 
       RowBox[{"\"\<Returns\>\"", ",", "15"}], "]"}], ",", " ", 
      RowBox[{"Style", "[", 
       RowBox[{"\"\<Probability\>\"", ",", "15"}], "]"}]}], "}"}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"BaseStyle", "\[Rule]", 
    RowBox[{"FontSize", "\[Rule]", "13"}]}], ",", "\[IndentingNewLine]", 
   RowBox[{"ImageSize", "\[Rule]", "500"}], ",", "\[IndentingNewLine]", 
   RowBox[{"PlotMarkers", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
   RowBox[{"GridLines", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "1", "}"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
   RowBox[{"Frame", "\[Rule]", "True"}]}], "\[IndentingNewLine]", 
  "]"}]}], "Input",
 CellChangeTimes->{{3.727110671488493*^9, 
  3.727110675440441*^9}},ExpressionUUID->"0ad426f2-d934-4cbd-bd44-\
0d1cca7da8ad"],

Cell["Dates of extreme events.", "Text",
 CellChangeTimes->{{3.727110840200939*^9, 
  3.727110844225133*^9}},ExpressionUUID->"63fd4fd1-2c2b-4911-b2f0-\
5f4e2dc9b626"],

Cell[BoxData[
 RowBox[{"Grid", "[", 
  RowBox[{
   RowBox[{"Join", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<Date\>\"", ",", "\"\<Return\>\""}], "}"}], "}"}], ",", 
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{"-", "datedReturns"}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"Last", "[", "#", "]"}], ">", "\[Gamma]right"}], "&"}]}], 
      "]"}]}], "]"}], ",", 
   RowBox[{"Frame", "\[Rule]", "All"}], ",", 
   RowBox[{"Background", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "Gray", "}"}]}], "}"}]}]}], "]"}]], "Input",
 CellChangeTimes->{
  3.7271106931903687`*^9},ExpressionUUID->"997ad0e5-5f33-4c3c-811f-\
85eedb749351"],

Cell["\<\
Probability of event under the assumption that returns decay as a exponential \
distribution\
\>", "Text",
 CellChangeTimes->{{3.7271882771033573`*^9, 3.7271882920356607`*^9}, {
  3.7271891332145967`*^9, 
  3.72718913628174*^9}},ExpressionUUID->"9cc4e4e5-2938-4666-915c-\
0d80e7691287"],

Cell[BoxData[
 RowBox[{"fit", " ", "=", " ", 
  RowBox[{"FindDistributionParameters", "[", 
   RowBox[{
    RowBox[{"Select", "[", 
     RowBox[{"neg", ",", 
      RowBox[{
       RowBox[{"#", "<", "\[Gamma]right"}], "&"}]}], "]"}], ",", 
    RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.72718874576884*^9, 3.727188797690907*^9}, {
   3.727188883936343*^9, 3.7271888866584177`*^9}, {3.727188957980174*^9, 
   3.72718898558529*^9}, {3.727189028431864*^9, 3.7271890308073273`*^9}, {
   3.727189106753908*^9, 3.7271891099115963`*^9}, 
   3.727189337879786*^9},ExpressionUUID->"9580971e-1657-4012-99d2-\
f8019da354de"],

Cell[BoxData[
 RowBox[{"Show", "[", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Plot", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"PDF", "[", 
       RowBox[{
        RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}], ",", 
        "x"}], "]"}], "/.", "fit"}], ",", 
     RowBox[{"{", 
      RowBox[{"x", ",", 
       RowBox[{"Min", "[", "neg", "]"}], ",", 
       RowBox[{"Max", "[", "neg", "]"}]}], "}"}], ",", 
     RowBox[{"PlotRange", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0.15"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "10"}], "}"}]}], "}"}]}], ",", 
     RowBox[{"PlotTheme", "\[Rule]", "\"\<Scientific\>\""}], ",", 
     RowBox[{"FrameLabel", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{"\"\<R\>\"", ",", "\"\<PDF\>\""}], "}"}]}], ",", 
     RowBox[{"PlotLegends", "\[Rule]", 
      RowBox[{"{", "\"\<Fit\>\"", "}"}]}]}], "]"}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"SmoothHistogram", "[", 
    RowBox[{
     RowBox[{"Select", "[", 
      RowBox[{"neg", ",", 
       RowBox[{
        RowBox[{"#", "<", "\[Gamma]right"}], "&"}]}], "]"}], ",", "Automatic",
      ",", "\"\<PDF\>\"", ",", 
     RowBox[{"PlotLegends", "\[Rule]", 
      RowBox[{"{", "\"\<Histogram\>\"", "}"}]}]}], "]"}]}], 
  "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.727188800707283*^9, 3.727188990367145*^9}, {
   3.7271890355465193`*^9, 3.727189035879492*^9}, 3.727189113813528*^9, {
   3.727189339273903*^9, 3.7271893530795307`*^9}, {3.727190327453538*^9, 
   3.727190340532604*^9}, {3.727190479217297*^9, 
   3.7271904989775457`*^9}},ExpressionUUID->"7e1f2223-8546-4741-a569-\
f9ae287523b3"],

Cell["As of feb 9, 2018, the return of the DJIA is", "Text",
 CellChangeTimes->{{3.727190350327991*^9, 
  3.727190372978718*^9}},ExpressionUUID->"61a71111-3eec-4bac-864d-\
e19316e11aa7"],

Cell[BoxData[
 RowBox[{"r", " ", "=", " ", 
  RowBox[{
   RowBox[{"-", 
    RowBox[{"Log", "[", "23516.27", "]"}]}], "+", 
   RowBox[{"Log", "[", "23860.46", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.7271896104934607`*^9, 
  3.727189611164228*^9}},ExpressionUUID->"46174aad-9897-41f9-9a80-\
a40258cc05e1"],

Cell["\<\
The probability of observing a return at least that extreme is:\
\>", "Text",
 CellChangeTimes->{{3.727190380854259*^9, 
  3.72719040553087*^9}},ExpressionUUID->"e673a2e6-0d62-4f85-b093-\
143ae566ad80"],

Cell[BoxData[
 RowBox[{"Probability", "[", 
  RowBox[{
   RowBox[{"x", "\[GreaterEqual]", " ", "r"}], ",", 
   RowBox[{
    RowBox[{"x", "\[Distributed]", 
     RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}]}], "/.", 
    "fit"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.7271895989051237`*^9, 
  3.727189636874218*^9}},ExpressionUUID->"fa6f0b7b-3ffd-4cdb-bff4-\
2b10ae771b1f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Extreme events functions", "Subchapter",
 CellChangeTimes->{{3.727190292379047*^9, 
  3.727190295979979*^9}},ExpressionUUID->"bf408954-5dc2-4ed3-b9e4-\
a0fbbdc666af"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ExtremeEventThreshold", "[", 
    RowBox[{"data_", ",", 
     RowBox[{"d\[Gamma]_:", "0.00001"}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Gamma]left", ",", "\[Gamma]right"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[Gamma]left", " ", "=", " ", 
       RowBox[{"LeftCutoff", "[", 
        RowBox[{"data", ",", "0.02", ",", 
         RowBox[{"Max", "[", "data", "]"}], ",", "d\[Gamma]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Gamma]right", "=", " ", 
       RowBox[{"RightCutoff", "[", 
        RowBox[{"data", ",", "\[Gamma]left", ",", 
         RowBox[{"Max", "[", "data", "]"}], ",", "d\[Gamma]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "\[Gamma]right", "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetExtremeEventDates", "[", "datedReturns_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "pos", ",", "neg", ",", "\[Gamma]", ",", "posDates", ",", "negDates"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"pos", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"datedReturns", ",", 
         RowBox[{
          RowBox[{"Last", "[", 
           RowBox[{"Positive", "[", "#", "]"}], "]"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Gamma]", " ", "=", " ", 
       RowBox[{"ExtremeEventThreshold", "[", 
        RowBox[{"pos", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"posDates", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"datedReturns", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Last", "[", "#", "]"}], ">", "\[Gamma]"}], "&"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"neg", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"datedReturns", ",", 
         RowBox[{
          RowBox[{"Last", "[", 
           RowBox[{"Negative", "[", "#", "]"}], "]"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Gamma]", " ", "=", " ", 
       RowBox[{"ExtremeEventThreshold", "[", 
        RowBox[{"-", 
         RowBox[{"neg", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"negDates", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"datedReturns", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Last", "[", 
            RowBox[{"-", "#"}], "]"}], ">", "\[Gamma]"}], "&"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"Join", "[", 
        RowBox[{"posDates", ",", "negDates"}], "]"}], "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.727190607829196*^9, 3.7271907852918787`*^9}, {
   3.7271908243916817`*^9, 3.727190969669409*^9}, 
   3.7271911145046663`*^9},ExpressionUUID->"5c950838-9ae1-4875-88dd-\
ff338b41ffb1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"datedReturns", " ", "=", " ", 
   RowBox[{"LogReturns", "[", 
    RowBox[{
     RowBox[{"Normal", "[", 
      RowBox[{"database", "[", 
       RowBox[{"All", ",", "\"\<Date\>\""}], "]"}], "]"}], ",", 
     RowBox[{"Normal", "[", 
      RowBox[{"database", "[", 
       RowBox[{"All", ",", "\"\<Close\>\""}], "]"}], "]"}], ",", "1"}], 
    "]"}]}], ";"}]], "Input",ExpressionUUID->"1da8756d-a331-4c4f-ae6d-\
15929c749418"],

Cell[BoxData[
 RowBox[{
  RowBox[{"dates", " ", "=", " ", 
   RowBox[{"GetExtremeEventDates", "[", "datedReturns", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.727190990167672*^9, 
  3.72719099797148*^9}},ExpressionUUID->"23373458-97fc-4117-840d-\
eb992d7af650"],

Cell[BoxData[
 RowBox[{"Grid", "[", 
  RowBox[{
   RowBox[{"Join", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<Date\>\"", ",", "\"\<Return\>\""}], "}"}], "}"}], ",", 
     "dates"}], "]"}], ",", 
   RowBox[{"Frame", "\[Rule]", "All"}], ",", 
   RowBox[{"Background", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "Gray", "}"}]}], "}"}]}]}], "]"}]], "Input",
 CellChangeTimes->{{3.727191504038995*^9, 
  3.727191522038106*^9}},ExpressionUUID->"7f227450-f15c-4eb2-99c7-\
29fe305d597a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"EventProbability", "[", 
   RowBox[{"returns_", ",", "event_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "selection", ",", "\[Gamma]", ",", "nonExtremeReturns", ",", "\[Lambda]",
       ",", "fit", ",", "r", ",", "p"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Positive", "[", "event", "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"selection", " ", "=", " ", 
         RowBox[{"Select", "[", 
          RowBox[{"returns", ",", "Positive"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Gamma]", " ", "=", " ", 
         RowBox[{"ExtremeEventThreshold", "[", "selection", "]"}]}], ";"}], 
       "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"selection", " ", "=", " ", 
         RowBox[{"-", 
          RowBox[{"Select", "[", 
           RowBox[{"returns", ",", "Negative"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Gamma]", " ", "=", " ", 
         RowBox[{"ExtremeEventThreshold", "[", "selection", "]"}]}], ";"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"nonExtremeReturns", " ", "=", " ", 
      RowBox[{"Select", "[", 
       RowBox[{"selection", ",", 
        RowBox[{
         RowBox[{"#", "<", "\[Gamma]"}], "&"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"fit", " ", "=", " ", 
      RowBox[{"FindDistributionParameters", "[", 
       RowBox[{"nonExtremeReturns", ",", 
        RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}]}], "]"}]}],
      ";", "\[IndentingNewLine]", 
     RowBox[{"p", " ", "=", " ", 
      RowBox[{"Probability", "[", 
       RowBox[{
        RowBox[{"r", "\[GreaterEqual]", " ", 
         RowBox[{"Abs", "[", "event", "]"}]}], ",", 
        RowBox[{"r", "\[Distributed]", 
         RowBox[{"ReplaceAll", "[", 
          RowBox[{
           RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}], ",", 
           "fit"}], "]"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Return", "[", "p", "]"}], ";"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.72719162956287*^9, 
  3.727191889193315*^9}},ExpressionUUID->"b12f7132-bf14-4025-be39-\
e2232665b89d"],

Cell[BoxData[
 RowBox[{"EventProbability", "[", 
  RowBox[{"returns", ",", 
   RowBox[{
    RowBox[{"Log", "[", "23516.27", "]"}], "-", 
    RowBox[{"Log", "[", "23860.46", "]"}]}]}], "]"}]], "Input",
 CellChangeTimes->{{3.727191909974792*^9, 
  3.72719192927746*^9}},ExpressionUUID->"0d2f9a05-7060-47ea-a04e-\
e7e2c1f012c5"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
WindowSize->{1431, 767},
WindowMargins->{{32, Automatic}, {Automatic, 88}},
FrontEndVersion->"11.1 for Linux x86 (64-bit) (April 18, 2017)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 166, 3, 93, "Title", "ExpressionUUID" -> \
"60ba662f-3ee6-4d2d-b353-d6d9d0d30be5"],
Cell[CellGroupData[{
Cell[771, 29, 156, 3, 66, "Chapter", "ExpressionUUID" -> \
"4e7ac71f-4885-442e-a569-8caa11781301"],
Cell[CellGroupData[{
Cell[952, 36, 156, 3, 64, "Subchapter", "ExpressionUUID" -> \
"4fafaa75-edaf-46cf-8726-d41ae796cef7"],
Cell[1111, 41, 313, 8, 77, "Input", "ExpressionUUID" -> \
"b6e72df1-aa88-4e6f-8365-24b21c96271a",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[1461, 54, 159, 3, 64, "Subchapter", "ExpressionUUID" -> \
"c2b4d8bf-6f05-43da-af37-fc2214af38da"],
Cell[1623, 59, 253, 6, 31, "Text", "ExpressionUUID" -> \
"50bcadff-3138-4cbb-9b00-493242ce20f5"],
Cell[CellGroupData[{
Cell[1901, 69, 224, 5, 33, "Input", "ExpressionUUID" -> \
"e218fe3a-dd97-4657-b96b-e7aba050f1a4"],
Cell[2128, 76, 10796, 196, 214, "Output", "ExpressionUUID" -> \
"2e948862-d584-4fdc-949b-2398557aed8e"]
}, Open  ]],
Cell[12939, 275, 414, 11, 35, "Input", "ExpressionUUID" -> \
"9d130389-0fcd-42bc-85f2-8231008c3059"],
Cell[13356, 288, 216, 5, 35, "Input", "ExpressionUUID" -> \
"439ed81d-63b6-45fa-b01d-113f3eaab47e"]
}, Open  ]],
Cell[CellGroupData[{
Cell[13609, 298, 159, 3, 64, "Subchapter", "ExpressionUUID" -> \
"1239b071-363f-41cf-b36c-d300db9927bc"],
Cell[13771, 303, 4508, 123, 433, "Input", "ExpressionUUID" -> \
"00eddca0-14bc-40cb-9e74-fc195473e6d4",
 InitializationCell->True]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[18328, 432, 159, 3, 66, "Chapter", "ExpressionUUID" -> \
"4bcb001a-247f-4b0c-adb2-d31dd5d10f88"],
Cell[CellGroupData[{
Cell[18512, 439, 169, 3, 64, "Subchapter", "ExpressionUUID" -> \
"02bac1df-e151-4925-a44a-99eda3c560cb"],
Cell[18684, 444, 6599, 169, 706, "Input", "ExpressionUUID" -> \
"60e5dcff-79ac-4220-ad81-9c903d59974a",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[25320, 618, 173, 3, 64, "Subchapter", "ExpressionUUID" -> \
"769c1546-351b-48b0-862b-75f5a739bcb9"],
Cell[25496, 623, 168, 3, 31, "Text", "ExpressionUUID" -> \
"d2093ab8-c4bf-4304-b95e-96704c1f3f9e"],
Cell[25667, 628, 1240, 30, 83, "Input", "ExpressionUUID" -> \
"4735b203-3d52-4f8d-9a06-9a0867ed6871"],
Cell[26910, 660, 165, 3, 31, "Text", "ExpressionUUID" -> \
"3d83a1ed-9d30-4839-9e93-059ecfcf8f0c"],
Cell[27078, 665, 275, 6, 35, "Input", "ExpressionUUID" -> \
"ccfb85eb-7e44-4e81-a54f-338029646bd4"],
Cell[27356, 673, 183, 3, 31, "Text", "ExpressionUUID" -> \
"90bf278f-d425-4c4d-957a-a749c038d5a0"],
Cell[27542, 678, 351, 9, 35, "Input", "ExpressionUUID" -> \
"1a9b39de-9a95-41a7-853b-92736e357d8a"],
Cell[27896, 689, 221, 5, 31, "Text", "ExpressionUUID" -> \
"0406e118-3085-441e-a1aa-3ac4673a0a83"],
Cell[28120, 696, 1882, 43, 320, "Input", "ExpressionUUID" -> \
"428415c1-8e82-4cce-a30c-1a3ccfd1aa91"],
Cell[30005, 741, 167, 3, 31, "Text", "ExpressionUUID" -> \
"b67cb207-9f3b-4d57-8408-17d0be2d58f2"],
Cell[30175, 746, 747, 22, 35, "Input", "ExpressionUUID" -> \
"fdf61b0b-0f5a-4f9c-946f-0d59db91fdb6"]
}, Open  ]],
Cell[CellGroupData[{
Cell[30959, 773, 170, 3, 64, "Subchapter", "ExpressionUUID" -> \
"a9c6d213-0b6d-49ab-afa4-0a37b1692314"],
Cell[31132, 778, 167, 3, 31, "Text", "ExpressionUUID" -> \
"1da03ce1-edee-4063-a0e4-1f556f090c08"],
Cell[31302, 783, 752, 21, 83, "Input", "ExpressionUUID" -> \
"e2a04dbf-c369-434e-a3eb-7cedd5bea1fa"],
Cell[32057, 806, 1781, 42, 320, "Input", "ExpressionUUID" -> \
"0ad426f2-d934-4cbd-bd44-0d1cca7da8ad"],
Cell[33841, 850, 166, 3, 31, "Text", "ExpressionUUID" -> \
"63fd4fd1-2c2b-4911-b2f0-5f4e2dc9b626"],
Cell[34010, 855, 721, 22, 35, "Input", "ExpressionUUID" -> \
"997ad0e5-5f33-4c3c-811f-85eedb749351"],
Cell[34734, 879, 296, 7, 31, "Text", "ExpressionUUID" -> \
"9cc4e4e5-2938-4666-915c-0d80e7691287"],
Cell[35033, 888, 676, 15, 35, "Input", "ExpressionUUID" -> \
"9580971e-1657-4012-99d2-f8019da354de"],
Cell[35712, 905, 1698, 43, 129, "Input", "ExpressionUUID" -> \
"7e1f2223-8546-4741-a569-f9ae287523b3"],
Cell[37413, 950, 186, 3, 31, "Text", "ExpressionUUID" -> \
"61a71111-3eec-4bac-864d-e19316e11aa7"],
Cell[37602, 955, 306, 8, 33, "Input", "ExpressionUUID" -> \
"46174aad-9897-41f9-9a80-a40258cc05e1"],
Cell[37911, 965, 212, 5, 31, "Text", "ExpressionUUID" -> \
"e673a2e6-0d62-4f85-b093-143ae566ad80"],
Cell[38126, 972, 389, 10, 35, "Input", "ExpressionUUID" -> \
"fa6f0b7b-3ffd-4cdb-bff4-2b10ae771b1f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[38552, 987, 172, 3, 64, "Subchapter", "ExpressionUUID" -> \
"bf408954-5dc2-4ed3-b9e4-a0fbbdc666af"],
Cell[38727, 992, 3231, 83, 370, "Input", "ExpressionUUID" -> \
"5c950838-9ae1-4875-88dd-ff338b41ffb1"],
Cell[41961, 1077, 456, 12, 35, "Input", "ExpressionUUID" -> \
"1da8756d-a331-4c4f-ae6d-15929c749418"],
Cell[42420, 1091, 268, 7, 35, "Input", "ExpressionUUID" -> \
"23373458-97fc-4117-840d-eb992d7af650"],
Cell[42691, 1100, 547, 16, 35, "Input", "ExpressionUUID" -> \
"7f227450-f15c-4eb2-99c7-29fe305d597a"],
Cell[43241, 1118, 2384, 57, 345, "Input", "ExpressionUUID" -> \
"b12f7132-bf14-4025-be39-e2232665b89d"],
Cell[45628, 1177, 325, 8, 35, "Input", "ExpressionUUID" -> \
"0d2f9a05-7060-47ea-a04e-e7e2c1f012c5"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

