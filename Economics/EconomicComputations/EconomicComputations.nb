(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     42789,       1131]
NotebookOptionsPosition[     37623,       1044]
NotebookOutlinePosition[     37961,       1059]
CellTagsIndexPosition[     37918,       1056]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Economic computations", "Title",
 CellChangeTimes->{{3.7271066814069443`*^9, 
  3.727106684836173*^9}},ExpressionUUID->"60ba662f-3ee6-4d2d-b353-\
d6d9d0d30be5"],

Cell[CellGroupData[{

Cell["Definitions", "Chapter",
 CellChangeTimes->{{3.727106716412622*^9, 
  3.727106721130731*^9}},ExpressionUUID->"4e7ac71f-4885-442e-a569-\
8caa11781301"],

Cell[CellGroupData[{

Cell["Paquetes", "Subchapter",
 CellChangeTimes->{{3.727108489123604*^9, 
  3.727108490069121*^9}},ExpressionUUID->"4fafaa75-edaf-46cf-8726-\
d41ae796cef7"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetDirectory", "[", 
   RowBox[{"NotebookDirectory", "[", "]"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Needs", "[", "\"\<AdvancedMapping`\>\"", "]"}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[13]:=",ExpressionUUID->"b6e72df1-aa88-4e6f-8365-24b21c96271a"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Data import", "Subchapter",
 CellChangeTimes->{{3.727106853297604*^9, 
  3.727106855064786*^9}},ExpressionUUID->"c2b4d8bf-6f05-43da-af37-\
fc2214af38da"],

Cell[CellGroupData[{

Cell["Create database", "Subsection",
 CellChangeTimes->{{3.737895869470508*^9, 
  3.73789587173361*^9}},ExpressionUUID->"52b90e15-a414-4820-be56-\
2086b5d69903"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Needs", "[", "\"\<DatasetBuilder`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"DatasetBuilderDialog", "[", "]"}], ";"}]}], "Input",
 CellChangeTimes->{{3.73789588815565*^9, 3.737895901030044*^9}},
 CellLabel->"In[15]:=",ExpressionUUID->"af10722c-9f7f-4e0c-bb41-6a197bb558cf"],

Cell[BoxData[
 RowBox[{
  RowBox[{"database", " ", "=", " ", 
   RowBox[{"Import", "[", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"NotebookDirectory", "[", "]"}], ",", "\"\<database.mx\>\""}], 
      "}"}], "]"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.737896587011231*^9, 3.7378966087008543`*^9}},
 CellLabel->"In[19]:=",ExpressionUUID->"0c93865f-4d1a-4e04-8334-bef8a8b2310e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"market", " ", "=", " ", 
   RowBox[{"First", "[", "database", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.737896684637188*^9, 3.737896690505457*^9}},
 CellLabel->"In[28]:=",ExpressionUUID->"a693faf6-dd62-40ee-a001-700eaf93d458"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Returns", "Subchapter",
 CellChangeTimes->{{3.7271067225213346`*^9, 
  3.7271067257125463`*^9}},ExpressionUUID->"1239b071-363f-41cf-b36c-\
d300db9927bc"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Returns1Day", "[", "prices_", "]"}], ":=", " ", 
   RowBox[{
    RowBox[{"Drop", "[", 
     RowBox[{"prices", ",", "1"}], "]"}], "-", 
    RowBox[{"Drop", "[", 
     RowBox[{"prices", ",", 
      RowBox[{"-", "1"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LogReturns", "[", 
    RowBox[{"prices_", ",", "lag_"}], "]"}], ":=", " ", 
   RowBox[{
    RowBox[{"Log", "[", 
     RowBox[{"Drop", "[", 
      RowBox[{"prices", ",", "lag"}], "]"}], "]"}], "-", 
    RowBox[{"Log", "[", 
     RowBox[{"Drop", "[", 
      RowBox[{"prices", ",", 
       RowBox[{"-", "lag"}]}], "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LogReturns", "[", 
     RowBox[{"dates_", ",", "prices_", ",", "lag_"}], "]"}], ":=", " ", 
    RowBox[{"Transpose", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Drop", "[", 
        RowBox[{"dates", ",", 
         RowBox[{"-", "1"}]}], "]"}], ",", 
       RowBox[{
        RowBox[{"Log", "[", 
         RowBox[{"Drop", "[", 
          RowBox[{"prices", ",", "lag"}], "]"}], "]"}], "-", 
        RowBox[{"Log", "[", 
         RowBox[{"Drop", "[", 
          RowBox[{"prices", ",", 
           RowBox[{"-", "lag"}]}], "]"}], "]"}]}]}], "}"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TrendDuration", "[", "prices_", "]"}], " ", ":=", " ", 
    RowBox[{"Map", "[", 
     RowBox[{"Length", ",", 
      RowBox[{"Split", "[", 
       RowBox[{"Sign", "[", 
        RowBox[{"Returns1Day", "[", "prices", "]"}], "]"}], "]"}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"$VersionNumber", "<", "11.2"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"TakeList", "[", 
       RowBox[{"list_", ",", "seqs_"}], "]"}], ":=", 
      RowBox[{"FoldPairList", "[", 
       RowBox[{"TakeDrop", ",", "list", ",", "seqs"}], "]"}]}], ";"}]}], 
   "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TrendReturns", "[", "prices_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "endpoints", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"endpoints", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"First", ",", 
         RowBox[{"TakeList", "[", 
          RowBox[{"prices", ",", 
           RowBox[{"Append", "[", 
            RowBox[{
             RowBox[{"TrendDuration", "[", "prices", "]"}], ",", "All"}], 
            "]"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"LogReturns", "[", "endpoints", "]"}], "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TrendReturns", "[", 
    RowBox[{"dates_", ",", "prices_"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", "endpoints", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"endpoints", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"First", ",", 
         RowBox[{"TakeList", "[", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"{", 
             RowBox[{"dates", ",", "prices"}], "}"}], "]"}], ",", 
           RowBox[{"Append", "[", 
            RowBox[{
             RowBox[{"TrendDuration", "[", "prices", "]"}], ",", "All"}], 
            "]"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"Transpose", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Drop", "[", 
           RowBox[{
            RowBox[{"endpoints", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
            RowBox[{"-", "1"}]}], "]"}], ",", 
          RowBox[{"LogReturns", "[", 
           RowBox[{"endpoints", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], "}"}], "]"}], 
       "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.727106731508418*^9, 3.727106731830819*^9}, {
  3.7271073948227797`*^9, 3.727107395062768*^9}, {3.727107524516037*^9, 
  3.72710752990876*^9}, {3.7271100223672953`*^9, 3.727110088754212*^9}, {
  3.727110314003048*^9, 3.7271103165843763`*^9}},
 CellLabel->"In[3]:=",ExpressionUUID->"00eddca0-14bc-40cb-9e74-fc195473e6d4"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Extreme events", "Chapter",
 CellChangeTimes->{{3.727107342517844*^9, 
  3.727107345217608*^9}},ExpressionUUID->"4bcb001a-247f-4b0c-adb2-\
d31dd5d10f88"],

Cell[CellGroupData[{

Cell["Anderson-Darling test", "Subchapter",
 CellChangeTimes->{{3.727107328104505*^9, 
  3.727107332788616*^9}},ExpressionUUID->"02bac1df-e151-4925-a44a-\
99eda3c560cb"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AndersonDarling", "[", 
     RowBox[{"data_", ",", "\[Gamma]_"}], "]"}], ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "s", ",", " ", "n", ",", "\[Alpha]", ",", "z", ",", "A2", ",", "i"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"s", " ", "=", " ", 
        RowBox[{"Sort", "[", "data", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"Count", "[", 
         RowBox[{"s", ",", 
          RowBox[{"x_", "/;", 
           RowBox[{"x", "\[GreaterEqual]", "\[Gamma]"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"n", ">", "1"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"s", " ", "=", " ", 
           RowBox[{"Take", "[", 
            RowBox[{"s", ",", 
             RowBox[{"-", "n"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"\[Alpha]", " ", "=", " ", 
           SuperscriptBox[
            RowBox[{"(", 
             RowBox[{
              FractionBox["1", "n"], " ", 
              RowBox[{"Sum", "[", 
               RowBox[{
                RowBox[{"Log", "[", 
                 FractionBox[
                  RowBox[{"s", "[", 
                   RowBox[{"[", "i", "]"}], "]"}], "\[Gamma]"], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"i", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ")"}], 
            RowBox[{"-", "1"}]]}], ";", "\[IndentingNewLine]", 
          RowBox[{"z", " ", "=", " ", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"1", "-", 
              SuperscriptBox[
               RowBox[{"(", 
                FractionBox["\[Gamma]", 
                 RowBox[{"s", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]], ")"}], "\[Alpha]"]}], ",", 
             
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"A2", " ", "=", " ", 
           RowBox[{
            RowBox[{"-", "n"}], "-", 
            RowBox[{
             FractionBox["1", "n"], 
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"2", "i"}], "-", "1"}], ")"}], 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Log", "[", 
                   RowBox[{"z", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "]"}], "+", 
                  RowBox[{"Log", "[", 
                   RowBox[{"1", "-", 
                    RowBox[{"z", "[", 
                    RowBox[{"[", 
                    RowBox[{"n", "-", "i", "+", "1"}], "]"}], "]"}]}], 
                   "]"}]}], ")"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"i", ",", "1", ",", "n"}], "}"}]}], "]"}]}]}]}], ";", 
          " ", "\[IndentingNewLine]", 
          RowBox[{"Return", "[", "A2", "]"}], ";"}], "\[IndentingNewLine]", 
         ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Return", "[", "\[Infinity]", "]"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"LeftCutoff", "[", 
     RowBox[{
     "data_", ",", "\[Gamma]min_", ",", "\[Gamma]max_", ",", "d\[Gamma]_"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"tbl", ",", "minPos", ",", "\[Gamma]"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"tbl", " ", "=", " ", 
        RowBox[{"ProgressTable", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\[Gamma]", ",", 
            RowBox[{"AndersonDarling", "[", 
             RowBox[{"data", ",", "\[Gamma]"}], "]"}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
           "\[Gamma]", ",", "\[Gamma]min", ",", "\[Gamma]max", ",", 
            "d\[Gamma]"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tbl", " ", "=", " ", 
        RowBox[{"DeleteCases", "[", 
         RowBox[{"tbl", ",", 
          RowBox[{"{", 
           RowBox[{"_", ",", "\[Infinity]"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"MinimalBy", "[", 
         RowBox[{"tbl", ",", "Last"}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RightCutoff", "[", 
    RowBox[{
    "data_", ",", "\[Gamma]left_", ",", "\[Gamma]max_", ",", "d\[Gamma]_"}], 
    "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"tbl", ",", "maxPos", ",", "\[Gamma]"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"tbl", " ", "=", " ", 
       RowBox[{"ProgressTable", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\[Gamma]", ",", 
           RowBox[{"AndersonDarling", "[", 
            RowBox[{"data", ",", "\[Gamma]"}], "]"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Gamma]", ",", "\[Gamma]max", ",", "\[Gamma]left", ",", 
           RowBox[{"-", "d\[Gamma]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"tbl", " ", "=", " ", 
       RowBox[{"DeleteCases", "[", 
        RowBox[{"tbl", ",", 
         RowBox[{"{", 
          RowBox[{"_", ",", "\[Infinity]"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"MaximalBy", "[", 
        RowBox[{"tbl", ",", "Last"}], "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.727107487173411*^9, 3.7271075004325867`*^9}, {
  3.727108000287654*^9, 3.727108000574614*^9}, {3.727108031860821*^9, 
  3.727108032324222*^9}, {3.727108122777183*^9, 3.727108185027569*^9}, {
  3.727108351806786*^9, 3.727108368729548*^9}, {3.727108505928026*^9, 
  3.727108525888134*^9}, {3.7271085703213577`*^9, 3.727108570975466*^9}, {
  3.727191255538129*^9, 3.727191269400065*^9}, {3.7271913099716988`*^9, 
  3.727191314339118*^9}, {3.737897882584166*^9, 3.737897885020751*^9}},
 CellLabel->"In[54]:=",ExpressionUUID->"60e5dcff-79ac-4220-ad81-9c903d59974a"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Positive extreme events", "Subchapter",
 CellChangeTimes->{{3.727110424056343*^9, 
  3.7271104282521048`*^9}},ExpressionUUID->"769c1546-351b-48b0-862b-\
75f5a739bcb9"],

Cell["Calculation of the returns", "Text",
 CellChangeTimes->{{3.727109977053843*^9, 
  3.727109983725967*^9}},ExpressionUUID->"d2093ab8-c4bf-4304-b95e-\
96704c1f3f9e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"pos", " ", "=", " ", 
   RowBox[{"Select", "[", 
    RowBox[{
     RowBox[{"market", "[", "\"\<Returns\>\"", "]"}], ",", "Positive"}], 
    "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.7271083061184387`*^9, 3.72710843851832*^9}, {
  3.727109495336327*^9, 3.727109496838745*^9}, {3.727109670593175*^9, 
  3.7271096748467607`*^9}, {3.727109727743472*^9, 3.727109734025447*^9}, {
  3.727109824331897*^9, 3.72710985014286*^9}, {3.7271101279389467`*^9, 
  3.727110143416807*^9}, {3.727110345153583*^9, 3.727110348138723*^9}, {
  3.737896807194372*^9, 
  3.73789681189855*^9}},ExpressionUUID->"4735b203-3d52-4f8d-9a06-\
9a0867ed6871"],

Cell["Start of power law decay", "Text",
 CellChangeTimes->{{3.727110754730159*^9, 
  3.72711076274268*^9}},ExpressionUUID->"3d83a1ed-9d30-4839-9e93-\
059ecfcf8f0c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"\[Gamma]left", " ", "=", " ", 
   RowBox[{"LeftCutoff", "[", 
    RowBox[{"pos", ",", "0.02", ",", 
     RowBox[{"Max", "[", "pos", "]"}], ",", "0.00001"}], "]"}]}], 
  ";"}]], "Input",ExpressionUUID->"ccfb85eb-7e44-4e81-a54f-338029646bd4"],

Cell["End of power law decay. Extreme events.", "Text",
 CellChangeTimes->{{3.727110765454918*^9, 
  3.7271107769037457`*^9}},ExpressionUUID->"90bf278f-d425-4c4d-957a-\
a749c038d5a0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"\[Gamma]right", "=", " ", 
   RowBox[{"RightCutoff", "[", 
    RowBox[{"pos", ",", "\[Gamma]left", ",", 
     RowBox[{"Max", "[", "pos", "]"}], ",", "0.00001"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.727108555620912*^9, 
  3.727108596121278*^9}},ExpressionUUID->"1a9b39de-9a95-41a7-853b-\
92736e357d8a"],

Cell["\<\
Plot of the distribution. Vertical line is the start of extreme events.\
\>", "Text",
 CellChangeTimes->{{3.727110792031796*^9, 
  3.727110808056546*^9}},ExpressionUUID->"0406e118-3085-441e-a1aa-\
3ac4673a0a83"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"histogramPoints", " ", "=", " ", 
   RowBox[{"Transpose", "[", 
    RowBox[{"MapAt", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Drop", "[", 
        RowBox[{"#", ",", "1"}], "]"}], "&"}], ",", 
      RowBox[{"HistogramList", "[", 
       RowBox[{"pos", ",", "60", ",", "\"\<Probability\>\""}], "]"}], ",", 
      "1"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"ListLogLogPlot", "[", "\[IndentingNewLine]", 
  RowBox[{"histogramPoints", ",", "\[IndentingNewLine]", 
   RowBox[{"GridLines", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", "\[Gamma]right", "}"}], ",", "None"}], "}"}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"PlotRange", "\[Rule]", "Full"}], ",", "\[IndentingNewLine]", 
   RowBox[{"PlotTheme", "\[Rule]", "\"\<Monochrome\>\""}], ",", " ", 
   "\[IndentingNewLine]", 
   RowBox[{"FrameLabel", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Style", "[", 
       RowBox[{"\"\<Returns\>\"", ",", "15"}], "]"}], ",", " ", 
      RowBox[{"Style", "[", 
       RowBox[{"\"\<Probability\>\"", ",", "15"}], "]"}]}], "}"}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"BaseStyle", "\[Rule]", 
    RowBox[{"FontSize", "\[Rule]", "13"}]}], ",", "\[IndentingNewLine]", 
   RowBox[{"ImageSize", "\[Rule]", "500"}], ",", "\[IndentingNewLine]", 
   RowBox[{"PlotMarkers", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
   RowBox[{"GridLines", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "1", "}"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
   RowBox[{"Frame", "\[Rule]", "True"}]}], "\[IndentingNewLine]", 
  "]"}]}], "Input",
 CellChangeTimes->{{3.7271092153048353`*^9, 3.727109254388513*^9}, {
  3.727109501055138*^9, 3.7271095018441267`*^9}, {3.7271107822856417`*^9, 
  3.727110782531336*^9}},ExpressionUUID->"428415c1-8e82-4cce-a30c-\
1a3ccfd1aa91"],

Cell["Dates of extreme event.", "Text",
 CellChangeTimes->{{3.727110811481201*^9, 
  3.7271108167230043`*^9}},ExpressionUUID->"b67cb207-9f3b-4d57-8408-\
17d0be2d58f2"],

Cell[BoxData[
 RowBox[{"Grid", "[", 
  RowBox[{
   RowBox[{"Join", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<Date\>\"", ",", "\"\<Return\>\""}], "}"}], "}"}], ",", 
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{"market", "[", "\"\<DatedReturns\>\"", "]"}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"Last", "[", "#", "]"}], ">", "\[Gamma]right"}], "&"}]}], 
      "]"}]}], "]"}], ",", 
   RowBox[{"Frame", "\[Rule]", "All"}], ",", 
   RowBox[{"Background", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "Gray", "}"}]}], "}"}]}]}], "]"}]], "Input",
 CellChangeTimes->{
  3.72711015620656*^9, {3.727110442780514*^9, 3.7271104947699347`*^9}, 
   3.737896794330729*^9},ExpressionUUID->"fdf61b0b-0f5a-4f9c-946f-\
0d59db91fdb6"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Negative extreme events", "Subchapter",
 CellChangeTimes->{{3.72711051110168*^9, 
  3.727110518937776*^9}},ExpressionUUID->"a9c6d213-0b6d-49ab-afa4-\
0a37b1692314"],

Cell["Plot of extreme events.", "Text",
 CellChangeTimes->{{3.7271108333814993`*^9, 
  3.727110836686514*^9}},ExpressionUUID->"1da03ce1-edee-4063-a0e4-\
1f556f090c08"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"neg", " ", "=", " ", 
   RowBox[{"-", 
    RowBox[{"Select", "[", 
     RowBox[{
      RowBox[{"market", "[", "\"\<Returns\>\"", "]"}], ",", "Negative"}], 
     "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Gamma]left", " ", "=", " ", 
   RowBox[{"LeftCutoff", "[", 
    RowBox[{"neg", ",", "0.02", ",", 
     RowBox[{"Max", "[", "neg", "]"}], ",", "0.00001"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Gamma]right", "=", " ", 
   RowBox[{"RightCutoff", "[", 
    RowBox[{"neg", ",", "\[Gamma]left", ",", 
     RowBox[{"Max", "[", "neg", "]"}], ",", "0.00001"}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.7271105249298077`*^9, 3.727110555979969*^9}, 
   3.7378968249492283`*^9},ExpressionUUID->"e2a04dbf-c369-434e-a3eb-\
7cedd5bea1fa"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"histogramPoints", " ", "=", " ", 
   RowBox[{"Transpose", "[", 
    RowBox[{"MapAt", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Drop", "[", 
        RowBox[{"#", ",", "1"}], "]"}], "&"}], ",", 
      RowBox[{"HistogramList", "[", 
       RowBox[{"neg", ",", "60", ",", "\"\<Probability\>\""}], "]"}], ",", 
      "1"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"ListLogLogPlot", "[", "\[IndentingNewLine]", 
  RowBox[{"histogramPoints", ",", "\[IndentingNewLine]", 
   RowBox[{"GridLines", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", "\[Gamma]right", "}"}], ",", "None"}], "}"}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"PlotRange", "\[Rule]", "Full"}], ",", "\[IndentingNewLine]", 
   RowBox[{"PlotTheme", "\[Rule]", "\"\<Monochrome\>\""}], ",", " ", 
   "\[IndentingNewLine]", 
   RowBox[{"FrameLabel", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Style", "[", 
       RowBox[{"\"\<Returns\>\"", ",", "15"}], "]"}], ",", " ", 
      RowBox[{"Style", "[", 
       RowBox[{"\"\<Probability\>\"", ",", "15"}], "]"}]}], "}"}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"BaseStyle", "\[Rule]", 
    RowBox[{"FontSize", "\[Rule]", "13"}]}], ",", "\[IndentingNewLine]", 
   RowBox[{"ImageSize", "\[Rule]", "500"}], ",", "\[IndentingNewLine]", 
   RowBox[{"PlotMarkers", "\[Rule]", "None"}], ",", "\[IndentingNewLine]", 
   RowBox[{"GridLines", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "1", "}"}]}], "}"}]}], ",", "\[IndentingNewLine]", 
   RowBox[{"Frame", "\[Rule]", "True"}]}], "\[IndentingNewLine]", 
  "]"}]}], "Input",
 CellChangeTimes->{{3.727110671488493*^9, 
  3.727110675440441*^9}},ExpressionUUID->"0ad426f2-d934-4cbd-bd44-\
0d1cca7da8ad"],

Cell["Dates of extreme events.", "Text",
 CellChangeTimes->{{3.727110840200939*^9, 
  3.727110844225133*^9}},ExpressionUUID->"63fd4fd1-2c2b-4911-b2f0-\
5f4e2dc9b626"],

Cell[BoxData[
 RowBox[{"Grid", "[", 
  RowBox[{
   RowBox[{"Join", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<Date\>\"", ",", "\"\<Return\>\""}], "}"}], "}"}], ",", 
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"market", "[", "\"\<DatedReturns\>\"", "]"}]}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"Last", "[", "#", "]"}], ">", "\[Gamma]right"}], "&"}]}], 
      "]"}]}], "]"}], ",", 
   RowBox[{"Frame", "\[Rule]", "All"}], ",", 
   RowBox[{"Background", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "Gray", "}"}]}], "}"}]}]}], "]"}]], "Input",
 CellChangeTimes->{3.7271106931903687`*^9, 
  3.7378968368219557`*^9},ExpressionUUID->"997ad0e5-5f33-4c3c-811f-\
85eedb749351"],

Cell["\<\
Probability of event under the assumption that returns decay as a exponential \
distribution\
\>", "Text",
 CellChangeTimes->{{3.7271882771033573`*^9, 3.7271882920356607`*^9}, {
  3.7271891332145967`*^9, 
  3.72718913628174*^9}},ExpressionUUID->"9cc4e4e5-2938-4666-915c-\
0d80e7691287"],

Cell[BoxData[
 RowBox[{"fit", " ", "=", " ", 
  RowBox[{"FindDistributionParameters", "[", 
   RowBox[{
    RowBox[{"Select", "[", 
     RowBox[{"neg", ",", 
      RowBox[{
       RowBox[{"#", "<", "\[Gamma]right"}], "&"}]}], "]"}], ",", 
    RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.72718874576884*^9, 3.727188797690907*^9}, {
   3.727188883936343*^9, 3.7271888866584177`*^9}, {3.727188957980174*^9, 
   3.72718898558529*^9}, {3.727189028431864*^9, 3.7271890308073273`*^9}, {
   3.727189106753908*^9, 3.7271891099115963`*^9}, 
   3.727189337879786*^9},ExpressionUUID->"9580971e-1657-4012-99d2-\
f8019da354de"],

Cell[BoxData[
 RowBox[{"Show", "[", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Plot", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"PDF", "[", 
       RowBox[{
        RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}], ",", 
        "x"}], "]"}], "/.", "fit"}], ",", 
     RowBox[{"{", 
      RowBox[{"x", ",", 
       RowBox[{"Min", "[", "neg", "]"}], ",", 
       RowBox[{"Max", "[", "neg", "]"}]}], "}"}], ",", 
     RowBox[{"PlotRange", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0.15"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "10"}], "}"}]}], "}"}]}], ",", 
     RowBox[{"PlotTheme", "\[Rule]", "\"\<Scientific\>\""}], ",", 
     RowBox[{"FrameLabel", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{"\"\<R\>\"", ",", "\"\<PDF\>\""}], "}"}]}], ",", 
     RowBox[{"PlotLegends", "\[Rule]", 
      RowBox[{"{", "\"\<Fit\>\"", "}"}]}]}], "]"}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"SmoothHistogram", "[", 
    RowBox[{
     RowBox[{"Select", "[", 
      RowBox[{"neg", ",", 
       RowBox[{
        RowBox[{"#", "<", "\[Gamma]right"}], "&"}]}], "]"}], ",", "Automatic",
      ",", "\"\<PDF\>\"", ",", 
     RowBox[{"PlotLegends", "\[Rule]", 
      RowBox[{"{", "\"\<Histogram\>\"", "}"}]}]}], "]"}]}], 
  "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.727188800707283*^9, 3.727188990367145*^9}, {
   3.7271890355465193`*^9, 3.727189035879492*^9}, 3.727189113813528*^9, {
   3.727189339273903*^9, 3.7271893530795307`*^9}, {3.727190327453538*^9, 
   3.727190340532604*^9}, {3.727190479217297*^9, 
   3.7271904989775457`*^9}},ExpressionUUID->"7e1f2223-8546-4741-a569-\
f9ae287523b3"],

Cell["As of feb 9, 2018, the return of the DJIA is", "Text",
 CellChangeTimes->{{3.727190350327991*^9, 
  3.727190372978718*^9}},ExpressionUUID->"61a71111-3eec-4bac-864d-\
e19316e11aa7"],

Cell[BoxData[
 RowBox[{"r", " ", "=", " ", 
  RowBox[{
   RowBox[{"-", 
    RowBox[{"Log", "[", "23516.27", "]"}]}], "+", 
   RowBox[{"Log", "[", "23860.46", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.7271896104934607`*^9, 
  3.727189611164228*^9}},ExpressionUUID->"46174aad-9897-41f9-9a80-\
a40258cc05e1"],

Cell["\<\
The probability of observing a return at least that extreme is:\
\>", "Text",
 CellChangeTimes->{{3.727190380854259*^9, 
  3.72719040553087*^9}},ExpressionUUID->"e673a2e6-0d62-4f85-b093-\
143ae566ad80"],

Cell[BoxData[
 RowBox[{"Probability", "[", 
  RowBox[{
   RowBox[{"x", "\[GreaterEqual]", " ", "r"}], ",", 
   RowBox[{
    RowBox[{"x", "\[Distributed]", 
     RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}]}], "/.", 
    "fit"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.7271895989051237`*^9, 
  3.727189636874218*^9}},ExpressionUUID->"fa6f0b7b-3ffd-4cdb-bff4-\
2b10ae771b1f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Extreme events functions", "Subchapter",
 CellChangeTimes->{{3.727190292379047*^9, 
  3.727190295979979*^9}},ExpressionUUID->"bf408954-5dc2-4ed3-b9e4-\
a0fbbdc666af"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ExtremeEventThreshold", "[", 
    RowBox[{"data_", ",", 
     RowBox[{"d\[Gamma]_:", "0.00001"}]}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Gamma]left", ",", "\[Gamma]right"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[Gamma]left", " ", "=", " ", 
       RowBox[{"LeftCutoff", "[", 
        RowBox[{"data", ",", "0.02", ",", 
         RowBox[{"Max", "[", "data", "]"}], ",", "d\[Gamma]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Gamma]right", "=", " ", 
       RowBox[{"RightCutoff", "[", 
        RowBox[{"data", ",", "\[Gamma]left", ",", 
         RowBox[{"Max", "[", "data", "]"}], ",", "d\[Gamma]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "\[Gamma]right", "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetExtremeEventDates", "[", "datedReturns_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "pos", ",", "neg", ",", "\[Gamma]", ",", "posDates", ",", "negDates"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"pos", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"datedReturns", ",", 
         RowBox[{
          RowBox[{"Last", "[", 
           RowBox[{"Positive", "[", "#", "]"}], "]"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Gamma]", " ", "=", " ", 
       RowBox[{"ExtremeEventThreshold", "[", 
        RowBox[{"pos", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"posDates", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"datedReturns", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Last", "[", "#", "]"}], ">", "\[Gamma]"}], "&"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"neg", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"datedReturns", ",", 
         RowBox[{
          RowBox[{"Last", "[", 
           RowBox[{"Negative", "[", "#", "]"}], "]"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Gamma]", " ", "=", " ", 
       RowBox[{"ExtremeEventThreshold", "[", 
        RowBox[{"-", 
         RowBox[{"neg", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"negDates", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"datedReturns", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Last", "[", 
            RowBox[{"-", "#"}], "]"}], ">", "\[Gamma]"}], "&"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"Join", "[", 
        RowBox[{"posDates", ",", "negDates"}], "]"}], "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.727190607829196*^9, 3.7271907852918787`*^9}, {
   3.7271908243916817`*^9, 3.727190969669409*^9}, 
   3.7271911145046663`*^9},ExpressionUUID->"5c950838-9ae1-4875-88dd-\
ff338b41ffb1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"dates", " ", "=", " ", 
   RowBox[{"GetExtremeEventDates", "[", 
    RowBox[{"market", "[", "\"\<DatedReturns\>\"", "]"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.727190990167672*^9, 3.72719099797148*^9}, 
   3.7378968474280376`*^9},ExpressionUUID->"23373458-97fc-4117-840d-\
eb992d7af650"],

Cell[BoxData[
 RowBox[{"Grid", "[", 
  RowBox[{
   RowBox[{"Join", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"{", 
       RowBox[{"\"\<Date\>\"", ",", "\"\<Return\>\""}], "}"}], "}"}], ",", 
     "dates"}], "]"}], ",", 
   RowBox[{"Frame", "\[Rule]", "All"}], ",", 
   RowBox[{"Background", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"None", ",", 
      RowBox[{"{", "Gray", "}"}]}], "}"}]}]}], "]"}]], "Input",
 CellChangeTimes->{{3.727191504038995*^9, 
  3.727191522038106*^9}},ExpressionUUID->"7f227450-f15c-4eb2-99c7-\
29fe305d597a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"EventProbability", "[", 
   RowBox[{"returns_", ",", "event_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "selection", ",", "\[Gamma]", ",", "nonExtremeReturns", ",", "\[Lambda]",
       ",", "fit", ",", "r", ",", "p"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Positive", "[", "event", "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"selection", " ", "=", " ", 
         RowBox[{"Select", "[", 
          RowBox[{"returns", ",", "Positive"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Gamma]", " ", "=", " ", 
         RowBox[{"ExtremeEventThreshold", "[", "selection", "]"}]}], ";"}], 
       "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"selection", " ", "=", " ", 
         RowBox[{"-", 
          RowBox[{"Select", "[", 
           RowBox[{"returns", ",", "Negative"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Gamma]", " ", "=", " ", 
         RowBox[{"ExtremeEventThreshold", "[", "selection", "]"}]}], ";"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"nonExtremeReturns", " ", "=", " ", 
      RowBox[{"Select", "[", 
       RowBox[{"selection", ",", 
        RowBox[{
         RowBox[{"#", "<", "\[Gamma]"}], "&"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"fit", " ", "=", " ", 
      RowBox[{"FindDistributionParameters", "[", 
       RowBox[{"nonExtremeReturns", ",", 
        RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}]}], "]"}]}],
      ";", "\[IndentingNewLine]", 
     RowBox[{"p", " ", "=", " ", 
      RowBox[{"Probability", "[", 
       RowBox[{
        RowBox[{"r", "\[GreaterEqual]", " ", 
         RowBox[{"Abs", "[", "event", "]"}]}], ",", 
        RowBox[{"r", "\[Distributed]", 
         RowBox[{"ReplaceAll", "[", 
          RowBox[{
           RowBox[{"ExponentialDistribution", "[", "\[Lambda]", "]"}], ",", 
           "fit"}], "]"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Return", "[", "p", "]"}], ";"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.72719162956287*^9, 
  3.727191889193315*^9}},ExpressionUUID->"b12f7132-bf14-4025-be39-\
e2232665b89d"],

Cell[BoxData[
 RowBox[{"EventProbability", "[", 
  RowBox[{"returns", ",", 
   RowBox[{
    RowBox[{"Log", "[", "23516.27", "]"}], "-", 
    RowBox[{"Log", "[", "23860.46", "]"}]}]}], "]"}]], "Input",
 CellChangeTimes->{{3.727191909974792*^9, 
  3.72719192927746*^9}},ExpressionUUID->"0d2f9a05-7060-47ea-a04e-\
e7e2c1f012c5"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Get gaussian returns", "Subchapter",
 CellChangeTimes->{{3.73789602276917*^9, 3.737896039002363*^9}, {
  3.737897200892376*^9, 
  3.73789720567597*^9}},ExpressionUUID->"a703d628-37ec-474a-b544-\
32a9a71a98c8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CalculateCutoff", "[", "absreturns_", "]"}], ":=", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "\[CapitalDelta]", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalDelta]", " ", "=", " ", 
        FractionBox[
         RowBox[{
          RowBox[{"Max", "[", "absreturns", "]"}], "-", 
          RowBox[{"Quantile", "[", 
           RowBox[{"absreturns", ",", "0.5"}], "]"}]}], "1000"]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"LeftCutoff", "[", 
        RowBox[{"absreturns", ",", 
         RowBox[{"Quantile", "[", 
          RowBox[{"absreturns", ",", "0.5"}], "]"}], ",", 
         RowBox[{"Max", "[", "absreturns", "]"}], ",", "\[CapitalDelta]"}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SelectGaussianReturns", "[", "returns_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"pos", ",", "neg", ",", "\[Gamma]pos", ",", "\[Gamma]neg"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"pos", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"returns", ",", "Positive"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"neg", " ", "=", " ", 
       RowBox[{"-", 
        RowBox[{"Select", "[", 
         RowBox[{"returns", ",", "Negative"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Gamma]pos", " ", "=", " ", 
       RowBox[{"CalculateCutoff", "[", "pos", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Gamma]neg", " ", "=", " ", 
       RowBox[{"CalculateCutoff", "[", "neg", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"pos", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"pos", ",", 
         RowBox[{
          RowBox[{"#", "<", " ", "\[Gamma]pos"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"neg", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"neg", ",", 
         RowBox[{
          RowBox[{"#", "<", " ", "\[Gamma]neg"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Join", "[", 
       RowBox[{"pos", ",", 
        RowBox[{"-", "neg"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.7378978024587*^9, 3.7378978186838083`*^9}, {
  3.737897987471901*^9, 3.737897990707348*^9}},
 CellLabel->"In[66]:=",ExpressionUUID->"ac202278-480a-436f-aa08-e8b515803306"],

Cell[BoxData[
 RowBox[{
  RowBox[{"greturns", " ", "=", " ", 
   RowBox[{"SelectGaussianReturns", "[", "returns", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.737898007842085*^9, 3.7378980109146214`*^9}},
 CellLabel->"In[69]:=",ExpressionUUID->"d9a5f6a0-ba5a-47fc-a083-c5862d1b790a"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
WindowSize->{1431, 767},
WindowMargins->{{Automatic, -1517}, {Automatic, 28}},
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 166, 3, 99, "Title",ExpressionUUID->"60ba662f-3ee6-4d2d-b353-d6d9d0d30be5"],
Cell[CellGroupData[{
Cell[771, 29, 156, 3, 70, "Chapter",ExpressionUUID->"4e7ac71f-4885-442e-a569-8caa11781301"],
Cell[CellGroupData[{
Cell[952, 36, 156, 3, 65, "Subchapter",ExpressionUUID->"4fafaa75-edaf-46cf-8726-d41ae796cef7"],
Cell[1111, 41, 334, 8, 73, "Input",ExpressionUUID->"b6e72df1-aa88-4e6f-8365-24b21c96271a",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[1482, 54, 159, 3, 65, "Subchapter",ExpressionUUID->"c2b4d8bf-6f05-43da-af37-fc2214af38da"],
Cell[CellGroupData[{
Cell[1666, 61, 162, 3, 55, "Subsection",ExpressionUUID->"52b90e15-a414-4820-be56-2086b5d69903"],
Cell[1831, 66, 334, 7, 57, "Input",ExpressionUUID->"af10722c-9f7f-4e0c-bb41-6a197bb558cf"],
Cell[2168, 75, 428, 10, 31, "Input",ExpressionUUID->"0c93865f-4d1a-4e04-8334-bef8a8b2310e"],
Cell[2599, 87, 267, 5, 31, "Input",ExpressionUUID->"a693faf6-dd62-40ee-a001-700eaf93d458"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[2915, 98, 159, 3, 65, "Subchapter",ExpressionUUID->"1239b071-363f-41cf-b36c-d300db9927bc"],
Cell[3077, 103, 4526, 122, 416, "Input",ExpressionUUID->"00eddca0-14bc-40cb-9e74-fc195473e6d4",
 InitializationCell->True]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[7652, 231, 159, 3, 70, "Chapter",ExpressionUUID->"4bcb001a-247f-4b0c-adb2-d31dd5d10f88"],
Cell[CellGroupData[{
Cell[7836, 238, 169, 3, 65, "Subchapter",ExpressionUUID->"02bac1df-e151-4925-a44a-99eda3c560cb"],
Cell[8008, 243, 6530, 166, 717, "Input",ExpressionUUID->"60e5dcff-79ac-4220-ad81-9c903d59974a",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[14575, 414, 173, 3, 65, "Subchapter",ExpressionUUID->"769c1546-351b-48b0-862b-75f5a739bcb9"],
Cell[14751, 419, 168, 3, 36, "Text",ExpressionUUID->"d2093ab8-c4bf-4304-b95e-96704c1f3f9e"],
Cell[14922, 424, 666, 14, 31, "Input",ExpressionUUID->"4735b203-3d52-4f8d-9a06-9a0867ed6871"],
Cell[15591, 440, 165, 3, 36, "Text",ExpressionUUID->"3d83a1ed-9d30-4839-9e93-059ecfcf8f0c"],
Cell[15759, 445, 275, 6, 31, "Input",ExpressionUUID->"ccfb85eb-7e44-4e81-a54f-338029646bd4"],
Cell[16037, 453, 183, 3, 36, "Text",ExpressionUUID->"90bf278f-d425-4c4d-957a-a749c038d5a0"],
Cell[16223, 458, 351, 9, 31, "Input",ExpressionUUID->"1a9b39de-9a95-41a7-853b-92736e357d8a"],
Cell[16577, 469, 221, 5, 36, "Text",ExpressionUUID->"0406e118-3085-441e-a1aa-3ac4673a0a83"],
Cell[16801, 476, 1882, 43, 308, "Input",ExpressionUUID->"428415c1-8e82-4cce-a30c-1a3ccfd1aa91"],
Cell[18686, 521, 167, 3, 36, "Text",ExpressionUUID->"b67cb207-9f3b-4d57-8408-17d0be2d58f2"],
Cell[18856, 526, 815, 23, 31, "Input",ExpressionUUID->"fdf61b0b-0f5a-4f9c-946f-0d59db91fdb6"]
}, Open  ]],
Cell[CellGroupData[{
Cell[19708, 554, 170, 3, 65, "Subchapter",ExpressionUUID->"a9c6d213-0b6d-49ab-afa4-0a37b1692314"],
Cell[19881, 559, 167, 3, 36, "Text",ExpressionUUID->"1da03ce1-edee-4063-a0e4-1f556f090c08"],
Cell[20051, 564, 825, 22, 78, "Input",ExpressionUUID->"e2a04dbf-c369-434e-a3eb-7cedd5bea1fa"],
Cell[20879, 588, 1781, 42, 308, "Input",ExpressionUUID->"0ad426f2-d934-4cbd-bd44-0d1cca7da8ad"],
Cell[22663, 632, 166, 3, 36, "Text",ExpressionUUID->"63fd4fd1-2c2b-4911-b2f0-5f4e2dc9b626"],
Cell[22832, 637, 792, 23, 31, "Input",ExpressionUUID->"997ad0e5-5f33-4c3c-811f-85eedb749351"],
Cell[23627, 662, 296, 7, 36, "Text",ExpressionUUID->"9cc4e4e5-2938-4666-915c-0d80e7691287"],
Cell[23926, 671, 676, 15, 31, "Input",ExpressionUUID->"9580971e-1657-4012-99d2-f8019da354de"],
Cell[24605, 688, 1698, 43, 124, "Input",ExpressionUUID->"7e1f2223-8546-4741-a569-f9ae287523b3"],
Cell[26306, 733, 186, 3, 36, "Text",ExpressionUUID->"61a71111-3eec-4bac-864d-e19316e11aa7"],
Cell[26495, 738, 306, 8, 31, "Input",ExpressionUUID->"46174aad-9897-41f9-9a80-a40258cc05e1"],
Cell[26804, 748, 212, 5, 36, "Text",ExpressionUUID->"e673a2e6-0d62-4f85-b093-143ae566ad80"],
Cell[27019, 755, 389, 10, 31, "Input",ExpressionUUID->"fa6f0b7b-3ffd-4cdb-bff4-2b10ae771b1f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[27445, 770, 172, 3, 65, "Subchapter",ExpressionUUID->"bf408954-5dc2-4ed3-b9e4-a0fbbdc666af"],
Cell[27620, 775, 3231, 83, 354, "Input",ExpressionUUID->"5c950838-9ae1-4875-88dd-ff338b41ffb1"],
Cell[30854, 860, 336, 8, 31, "Input",ExpressionUUID->"23373458-97fc-4117-840d-eb992d7af650"],
Cell[31193, 870, 547, 16, 31, "Input",ExpressionUUID->"7f227450-f15c-4eb2-99c7-29fe305d597a"],
Cell[31743, 888, 2384, 57, 331, "Input",ExpressionUUID->"b12f7132-bf14-4025-be39-e2232665b89d"],
Cell[34130, 947, 325, 8, 31, "Input",ExpressionUUID->"0d2f9a05-7060-47ea-a04e-e7e2c1f012c5"]
}, Open  ]],
Cell[CellGroupData[{
Cell[34492, 960, 215, 4, 65, "Subchapter",ExpressionUUID->"a703d628-37ec-474a-b544-32a9a71a98c8"],
Cell[34710, 966, 2584, 66, 392, "Input",ExpressionUUID->"ac202278-480a-436f-aa08-e8b515803306",
 InitializationCell->True],
Cell[37297, 1034, 286, 5, 31, "Input",ExpressionUUID->"d9a5f6a0-ba5a-47fc-a083-c5862d1b790a"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

